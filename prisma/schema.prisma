// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Provider {
  CHASE
  VENMO
}

enum AccountType {
  CHECKING
  WALLET
}

enum RuleMatchType {
  CONTAINS
  REGEX
}

enum Direction {
  INFLOW
  OUTFLOW
  NONE
}

enum CategoryKind {
  INCOME
  EXPENSE
  TRANSFER
}

enum FileStatus {
  PENDING
  PROCESSED
  ERROR
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  lastActive DateTime @default(now())
  
  accounts     Account[]
  categories   Category[]
  importFiles  ImportFile[]
  transactions Transaction[]
  rules        CategoryRule[]
  
  @@index([token])
  @@index([expiresAt])
}

model Account {
  id          String        @id @default(uuid())
  sessionId   String
  session     Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  provider    Provider
  type        AccountType
  displayName String
  last4       String?
  currency    String        @default("USD")
  createdAt   DateTime      @default(now())
  
  transactions Transaction[]
  rules        CategoryRule[]
  
  @@unique([sessionId, provider, type, displayName])
  @@index([sessionId])
}

model Category {
  id        String       @id @default(uuid())
  sessionId String
  session   Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  name      String
  kind      CategoryKind
  parentId  String?
  createdAt DateTime     @default(now())
  
  rules CategoryRule[]
  txs   Transaction[]
  
  @@unique([sessionId, name])
  @@index([sessionId])
}

model ImportFile {
  id          String      @id @default(uuid())
  sessionId   String
  session     Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  source      Provider
  filename    String
  sha256      String
  rowCount    Int         @default(0)
  imported    Int         @default(0)
  duplicates  Int         @default(0)
  status      FileStatus  @default(PENDING)
  error       String?
  processedAt DateTime?
  createdAt   DateTime    @default(now())
  
  transactions Transaction[]
  
  @@unique([sessionId, sha256])
  @@index([sessionId])
}

model Transaction {
  id                String      @id @default(uuid())
  sessionId         String
  session           Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  source            Provider
  externalId        String?
  accountId         String
  account           Account     @relation(fields: [accountId], references: [id])
  postedAt          DateTime
  postedDate        DateTime
  descriptionRaw    String
  descriptionNorm   String
  amountCents       Int         // + inflow, - outflow
  currency          String      @default("USD")
  categoryId        String?
  category          Category?   @relation(fields: [categoryId], references: [id])
  isTransfer        Boolean     @default(false)
  transferGroupId   String?
  transferCandidate Boolean     @default(false) // for review queue
  importFileId      String?
  importFile        ImportFile? @relation(fields: [importFileId], references: [id])
  hashUnique        String
  notes             String?
  createdAt         DateTime    @default(now())

  @@unique([sessionId, hashUnique])
  @@index([sessionId])
  @@index([sessionId, accountId, postedDate])
  @@index([sessionId, categoryId, postedDate])
  @@index([sessionId, postedDate, amountCents])
  @@index([sessionId, isTransfer])
  @@index([sessionId, transferCandidate])
}

model CategoryRule {
  id         String        @id @default(uuid())
  sessionId  String
  session    Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  accountId  String?
  account    Account?      @relation(fields: [accountId], references: [id])
  matchType  RuleMatchType @default(CONTAINS)
  pattern    String
  direction  Direction     @default(NONE)
  categoryId String
  category   Category      @relation(fields: [categoryId], references: [id])
  priority   Int           @default(100)
  enabled    Boolean       @default(true)
  createdAt  DateTime      @default(now())

  @@index([sessionId])
  @@index([sessionId, priority, enabled])
}

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}